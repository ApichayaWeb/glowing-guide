<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container mt-5">
        <h2>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)</h2>
        
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h5>
            <div id="debugInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        </div>
        
        <div class="card mt-4">
            <div class="card-body">
                <form id="testForm">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label>
                        <input type="text" class="form-control" id="groupName" value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ú‡∏±‡∏Å‡∏õ‡∏•‡∏≠‡∏î‡∏™‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö" required>
                    </div>
                    <div class="mb-3">
                        <label for="managerUsername" class="form-label">Username ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</label>
                        <input type="text" class="form-control" id="managerUsername" value="test_manager" required>
                    </div>
                    <div class="mb-3">
                        <label for="managerPassword" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</label>
                        <input type="password" class="form-control" id="managerPassword" value="123456" required>
                    </div>
                    <button type="submit" class="btn btn-success" id="submitBtn">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
                    <button type="button" class="btn btn-secondary ms-2" onclick="clearResults()">‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
                </form>
                
                <div id="results" class="mt-4"></div>
            </div>
        </div>

        <!-- Debug Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏ö‡∏±‡∏Å</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-outline-info btn-sm" onclick="showDebugInfo()">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏µ‡∏ö‡∏±‡∏Å</button>
                <button class="btn btn-outline-warning btn-sm" onclick="clearLocalStorage()">‡∏•‡πâ‡∏≤‡∏á LocalStorage</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="showStoredGroups()">‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ</button>
                <div id="debugResults" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api.js"></script>
    
    <script>
        let debugMode = true;

        function log(message, data) {
            if (debugMode) {
                console.log(message, data);
            }
        }

        // Check if required objects are loaded
        document.addEventListener('DOMContentLoaded', function() {
            log('=== DOM Content Loaded ===');
            
            setTimeout(() => {
                checkDependencies();
            }, 100);
        });

        function checkDependencies() {
            const debugInfo = document.getElementById('debugInfo');
            let infoHtml = '<ul>';
            
            const checks = [
                { name: 'Utils', obj: typeof Utils },
                { name: 'CONFIG', obj: typeof CONFIG },
                { name: 'API', obj: typeof API },
                { name: 'AdminAPI', obj: typeof AdminAPI },
                { name: 'AdminAPI.createGroup', obj: typeof (AdminAPI ? AdminAPI.createGroup : undefined) }
            ];

            checks.forEach(check => {
                const status = check.obj !== 'undefined' ? '‚úÖ' : '‚ùå';
                infoHtml += `<li>${status} ${check.name}: ${check.obj}</li>`;
            });

            infoHtml += '</ul>';
            debugInfo.innerHTML = infoHtml;

            if (typeof AdminAPI === 'undefined') {
                document.getElementById('results').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö AdminAPI</h5>
                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå assets/js/api.js ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
                        <p>‡πÄ‡∏õ‡∏¥‡∏î Developer Tools (F12) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
                    </div>
                `;
                document.getElementById('submitBtn').disabled = true;
            } else {
                document.getElementById('results').innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
                        <p>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß</p>
                    </div>
                `;
            }
        }

        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            log('=== Form Submit Started ===');
            
            // Pre-flight checks
            if (typeof AdminAPI === 'undefined') {
                alert('AdminAPI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                // Disable button and show loading
                submitBtn.disabled = true;
                submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';

                const formData = {
                    groupName: document.getElementById('groupName').value,
                    managerUsername: document.getElementById('managerUsername').value,
                    managerPassword: document.getElementById('managerPassword').value
                };
                
                log('=== Testing Create Group ===');
                log('Form data:', formData);
                log('AdminAPI.createGroup type:', typeof AdminAPI.createGroup);

                // Show loading message
                document.getElementById('results').innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£...</span>
                        </div>
                    </div>
                `;

                const result = await AdminAPI.createGroup(formData);
                log('Full API result:', result);
                
                // Check if result has success property and group data
                if (result && result.success === true && result.group) {
                    log('Success! Group created:', result.group);
                    
                    document.getElementById('results').innerHTML = `
                        <div class="alert alert-success">
                            <h5>üéâ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</strong> ${result.message || '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'}</p>
                                    <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏•‡∏∏‡πà‡∏°:</strong> <span class="badge bg-primary">${result.group.groupCode}</span></p>
                                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°:</strong> ${result.group.groupName}</p>
                                    <p><strong>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£:</strong> ${result.group.managerUsername}</p>
                                    <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="badge bg-success">${result.group.status}</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Group ID:</strong> <code>${result.group.groupId}</code></p>
                                    <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á:</strong> ${new Date(result.group.created).toLocaleString('th-TH')}</p>
                                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£:</strong> ${result.group.statistics.totalFarmers} ‡∏£‡∏≤‡∏¢</p>
                                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô QR Code:</strong> ${result.group.statistics.totalQRCodes} ‡∏£‡∏´‡∏±‡∏™</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
                        text: `‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏•‡∏∏‡πà‡∏°: ${result.group.groupCode}`,
                        confirmButtonColor: '#28a745'
                    });
                    
                } else {
                    log('Unexpected result structure:', result);
                    
                    document.getElementById('results').innerHTML = `
                        <div class="alert alert-warning">
                            <h5>‚ö†Ô∏è ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î</h5>
                            <p><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</strong></p>
                            <pre class="bg-light p-2 rounded">${JSON.stringify(result, null, 2)}</pre>
                            <p class="mt-2"><small>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</small></p>
                        </div>
                    `;
                }
                
            } catch (error) {
                log('Error caught:', error);
                
                document.getElementById('results').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h5>
                        <p><strong>‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong> ${error.message}</p>
                        <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong></p>
                        <pre class="bg-light p-2 rounded">${error.stack || error.toString()}</pre>
                    </div>
                `;
                
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Debug functions
        function showDebugInfo() {
            const debugInfo = {
                currentUser: typeof AuthAPI !== 'undefined' ? AuthAPI.getCurrentUser() : 'AuthAPI not loaded',
                localStorage: {
                    mockGroups: localStorage.getItem('mockGroups'),
                    user_data: localStorage.getItem('user_data'),
                    auth_token: localStorage.getItem('auth_token')
                },
                apiStatus: {
                    Utils: typeof Utils,
                    CONFIG: typeof CONFIG,
                    API: typeof API,
                    AdminAPI: typeof AdminAPI
                }
            };

            document.getElementById('debugResults').innerHTML = `
                <div class="alert alert-info">
                    <h6>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏µ‡∏ö‡∏±‡∏Å</h6>
                    <pre class="bg-light p-2 rounded">${JSON.stringify(debugInfo, null, 2)}</pre>
                </div>
            `;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('debugResults').innerHTML = '';
        }

        function clearLocalStorage() {
            localStorage.removeItem('mockGroups');
            localStorage.removeItem('user_data');
            localStorage.removeItem('auth_token');
            alert('‡∏•‡πâ‡∏≤‡∏á LocalStorage ‡πÅ‡∏•‡πâ‡∏ß');
            location.reload();
        }

        function showStoredGroups() {
            const groups = JSON.parse(localStorage.getItem('mockGroups') || '[]');
            document.getElementById('debugResults').innerHTML = `
                <div class="alert alert-secondary">
                    <h6>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô LocalStorage (${groups.length} ‡∏Å‡∏•‡∏∏‡πà‡∏°)</h6>
                    <pre class="bg-light p-2 rounded">${JSON.stringify(groups, null, 2)}</pre>
                </div>
            `;
        }
    </script>
</body>
</html>