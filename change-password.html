<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เปลี่ยนรหัสผ่าน - ระบบสอบย้อนกลับผักอุดร</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/auth.css">
</head>
<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center align-items-center min-vh-100">
            <div class="col-md-6 col-lg-5">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-warning text-dark text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-key fa-3x"></i>
                        </div>
                        <h4 class="mb-2">จำเป็นต้องเปลี่ยนรหัสผ่าน</h4>
                        <p class="mb-0 small">
                            เนื่องจากนี่เป็นการเข้าสู่ระบบครั้งแรก กรุณาเปลี่ยนรหัสผ่านเพื่อความปลอดภัย
                        </p>
                    </div>
                    
                    <div class="card-body p-4">
                        <form id="changePasswordForm">
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>ข้อกำหนดรหัสผ่าน:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>มีความยาวอย่างน้อย 6 ตัวอักษร</li>
                                    <li>ไม่ควรใช้รหัสผ่านเดิม</li>
                                </ul>
                            </div>
                            
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">
                                    <i class="fas fa-lock me-1"></i>รหัสผ่านปัจจุบัน
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="currentPassword" required
                                           placeholder="ใส่รหัสผ่านปัจจุบัน">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">
                                    <i class="fas fa-key me-1"></i>รหัสผ่านใหม่
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="newPassword" required
                                           minlength="6" placeholder="ใส่รหัสผ่านใหม่">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <div id="passwordStrength" class="mt-2"></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="confirmPassword" class="form-label">
                                    <i class="fas fa-check-double me-1"></i>ยืนยันรหัสผ่านใหม่
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirmPassword" required
                                           minlength="6" placeholder="ใส่รหัสผ่านใหม่อีกครั้ง">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div id="passwordMatch" class="form-text mt-1"></div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success btn-lg" id="changePasswordBtn">
                                    <i class="fas fa-save me-2"></i>เปลี่ยนรหัสผ่าน
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card-footer text-center py-3 bg-light">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            ระบบจะออกจากระบบอัตโนมัติหลังจากเปลี่ยนรหัสผ่านสำเร็จ
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">กำลังโหลด...</span>
            </div>
            <p class="mt-3">กำลังเปลี่ยนรหัสผ่าน...</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Custom Scripts -->
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>

    <script>
        // Check if user is required to change password
        document.addEventListener('DOMContentLoaded', function() {
            const forcePasswordChange = Storage.get('force_password_change');
            const currentUser = AuthAPI.getCurrentUser();
            
            if (!forcePasswordChange || !currentUser) {
                // Redirect to login if not in forced password change mode
                window.location.href = 'login.html';
                return;
            }
            
            // Show user info
            const userInfo = `${currentUser.username} (${currentUser.role})`;
            document.querySelector('.card-header p').innerHTML = `
                กำลังเข้าสู่ระบบในนาม: <strong>${userInfo}</strong><br>
                เนื่องจากนี่เป็นการเข้าสู่ระบบครั้งแรก กรุณาเปลี่ยนรหัสผ่านเพื่อความปลอดภัย
            `;
        });

        // Toggle password visibility
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                field.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Password strength checker
        function checkPasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            let strength = 0;
            let feedback = [];
            
            if (password.length >= 6) strength++;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            const strengthText = ['อ่อนมาก', 'อ่อน', 'ปานกลาง', 'แข็งแรง', 'แข็งแรงมาก'];
            const strengthColors = ['danger', 'warning', 'info', 'success', 'success'];
            const strengthIndex = Math.min(Math.floor(strength * strengthText.length / 6), strengthText.length - 1);
            
            if (password.length > 0) {
                strengthDiv.innerHTML = `
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-${strengthColors[strengthIndex]}" 
                             style="width: ${(strengthIndex + 1) * 20}%"></div>
                    </div>
                    <small class="text-${strengthColors[strengthIndex]}">
                        ความแข็งแรง: ${strengthText[strengthIndex]}
                    </small>
                `;
            } else {
                strengthDiv.innerHTML = '';
            }
        }

        // Password match checker
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchDiv = document.getElementById('passwordMatch');
            
            if (confirmPassword.length > 0) {
                if (newPassword === confirmPassword) {
                    matchDiv.innerHTML = '<small class="text-success"><i class="fas fa-check me-1"></i>รหัสผ่านตรงกัน</small>';
                } else {
                    matchDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times me-1"></i>รหัสผ่านไม่ตรงกัน</small>';
                }
            } else {
                matchDiv.innerHTML = '';
            }
        }

        // Event listeners for password validation
        document.getElementById('newPassword').addEventListener('input', function() {
            checkPasswordStrength(this.value);
            checkPasswordMatch();
        });

        document.getElementById('confirmPassword').addEventListener('input', function() {
            checkPasswordMatch();
        });

        // Handle form submission
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                Utils.showWarning('รหัสผ่านไม่ตรงกัน', 'กรุณาตรวจสอบรหัสผ่านใหม่');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 6) {
                Utils.showWarning('รหัสผ่านสั้นเกินไป', 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }
            
            // Check if new password is different from current
            if (currentPassword === newPassword) {
                Utils.showWarning('รหัสผ่านเหมือนเดิม', 'กรุณาใช้รหัสผ่านที่แตกต่างจากรหัสผ่านปัจจุบัน');
                return;
            }
            
            try {
                Utils.showLoading();
                
                await AuthAPI.changePassword(currentPassword, newPassword);
                
                Utils.hideLoading();
                
                // Show success message and redirect
                Swal.fire({
                    icon: 'success',
                    title: 'เปลี่ยนรหัสผ่านสำเร็จ',
                    html: `
                        <p>รหัสผ่านของคุณได้ถูกเปลี่ยนเรียบร้อยแล้ว</p>
                        <p>ระบบจะนำคุณกลับไปหน้าเข้าสู่ระบบ</p>
                    `,
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then(() => {
                    window.location.href = 'login.html';
                });
                
            } catch (error) {
                Utils.hideLoading();
                Utils.showError('เกิดข้อผิดพลาด', error.message || 'ไม่สามารถเปลี่ยนรหัสผ่านได้');
            }
        });

        // Prevent back navigation
        window.addEventListener('popstate', function() {
            window.location.href = 'change-password.html';
        });
        
        // Push state to prevent back button
        window.history.pushState(null, null, window.location.href);
    </script>
</body>
</html>