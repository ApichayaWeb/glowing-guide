<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Helper - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏±‡∏Å‡∏≠‡∏∏‡∏î‡∏£</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-5">üõ†Ô∏è Debug Helper</h1>
        
        <!-- API Connection Test -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-plug me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="apiUrl" class="form-label">Google Apps Script URL:</label>
                    <input type="text" class="form-control" id="apiUrl" 
                           placeholder="https://script.google.com/macros/s/YOUR_ID/exec">
                    <div class="form-text">‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Apps Script Deploy</div>
                </div>
                <button class="btn btn-primary" onclick="testApiConnection()">
                    <i class="fas fa-test-tube me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                </button>
                <div id="apiTestResult" class="mt-3"></div>
            </div>
        </div>

        <!-- JavaScript Dependencies Test -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-code me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö JavaScript Dependencies</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="testJSDependencies()">
                    <i class="fas fa-check-circle me-2"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Dependencies
                </button>
                <div id="jsTestResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Login Test -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-sign-in-alt me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Login</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="testUsername" class="form-label">Username:</label>
                            <input type="text" class="form-control" id="testUsername" value="admin">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="testPassword" class="form-label">Password:</label>
                            <input type="password" class="form-control" id="testPassword" value="admin_password">
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="testLogin()">
                    <i class="fas fa-user-check me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Login
                </button>
                <div id="loginTestResult" class="mt-3"></div>
            </div>
        </div>

        <!-- QR Code Test -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-qrcode me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö QR Code</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="testQRCode" class="form-label">QR Code:</label>
                    <input type="text" class="form-control" id="testQRCode" value="01-4102010502568">
                    <div class="form-text">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ QR Code ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
                </div>
                <button class="btn btn-warning" onclick="testQRCode()">
                    <i class="fas fa-search me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö QR Code
                </button>
                <div id="qrTestResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Console Log -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-terminal me-2"></i>Console Log</h5>
            </div>
            <div class="card-body">
                <div id="consoleLog" style="background: #2d3748; color: #e2e8f0; border-radius: 4px; padding: 1rem; font-family: monospace; height: 300px; overflow-y: auto;">
                    <!-- Console output will appear here -->
                </div>
                <button class="btn btn-secondary mt-2" onclick="clearConsole()">
                    <i class="fas fa-trash me-2"></i>Clear Console
                </button>
            </div>
        </div>

        <!-- System Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-line me-2"></i>System Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="status-item">
                            <div class="status-label">API Connection:</div>
                            <div class="status-value" id="apiStatus">‚ùì Unknown</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="status-item">
                            <div class="status-label">JavaScript:</div>
                            <div class="status-value" id="jsStatus">‚ùì Unknown</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="status-item">
                            <div class="status-label">Authentication:</div>
                            <div class="status-value" id="authStatus">‚ùì Unknown</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="status-item">
                            <div class="status-label">QR Scanner:</div>
                            <div class="status-value" id="qrStatus">‚ùì Unknown</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    
    <!-- Load system scripts for testing -->
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>

    <style>
        .status-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .status-label {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .status-value {
            font-size: 1.2rem;
        }
    </style>

    <script>
        // Console logging
        function log(message, type = 'info') {
            const consoleEl = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                'info': '#e2e8f0',
                'success': '#48bb78',
                'error': '#f56565',
                'warning': '#ed8936'
            }[type] || '#e2e8f0';
            
            consoleEl.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('consoleLog').innerHTML = '';
        }

        // Test API Connection
        async function testApiConnection() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            
            if (!apiUrl) {
                log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API URL', 'error');
                return;
            }

            try {
                log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API...', 'info');
                
                // Update CONFIG
                if (window.CONFIG) {
                    window.CONFIG.API_BASE_URL = apiUrl;
                }
                
                const response = await fetch(apiUrl + '?info=true');
                const data = await response.json();
                
                log('‚úÖ API Connection ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                log(`API Response: ${JSON.stringify(data)}`, 'info');
                
                document.getElementById('apiTestResult').innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong><br>
                        API Name: ${data.name || 'Unknown'}<br>
                        Status: ${data.status || 'Unknown'}<br>
                        Version: ${data.version || 'Unknown'}
                    </div>
                `;
                
                document.getElementById('apiStatus').innerHTML = '‚úÖ Connected';
                document.getElementById('apiStatus').className = 'status-value text-success';
                
            } catch (error) {
                log(`‚ùå API Connection ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
                
                document.getElementById('apiTestResult').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!</strong><br>
                        Error: ${error.message}<br>
                        ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞ CORS settings
                    </div>
                `;
                
                document.getElementById('apiStatus').innerHTML = '‚ùå Failed';
                document.getElementById('apiStatus').className = 'status-value text-danger';
            }
        }

        // Test JavaScript Dependencies
        function testJSDependencies() {
            log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö JavaScript Dependencies...', 'info');
            
            const dependencies = [
                { name: 'Utils', object: window.Utils },
                { name: 'CONFIG', object: window.CONFIG },
                { name: 'Storage', object: window.Storage },
                { name: 'API', object: window.API },
                { name: 'AuthAPI', object: window.AuthAPI },
                { name: 'QRAPI', object: window.QRAPI },
                { name: 'AdminAPI', object: window.AdminAPI },
                { name: 'GroupAPI', object: window.GroupAPI },
                { name: 'FarmerAPI', object: window.FarmerAPI }
            ];
            
            let allPassed = true;
            let resultHtml = '<div class="list-group">';
            
            dependencies.forEach(dep => {
                const exists = typeof dep.object !== 'undefined';
                const status = exists ? '‚úÖ' : '‚ùå';
                const className = exists ? 'list-group-item-success' : 'list-group-item-danger';
                
                if (!exists) allPassed = false;
                
                resultHtml += `
                    <div class="list-group-item ${className}">
                        ${status} ${dep.name} ${exists ? '‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß' : '‡πÑ‡∏°‡πà‡∏û‡∏ö'}
                    </div>
                `;
                
                log(`${status} ${dep.name}: ${exists ? '‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß' : '‡πÑ‡∏°‡πà‡∏û‡∏ö'}`, exists ? 'success' : 'error');
            });
            
            resultHtml += '</div>';
            document.getElementById('jsTestResult').innerHTML = resultHtml;
            
            if (allPassed) {
                document.getElementById('jsStatus').innerHTML = '‚úÖ All Loaded';
                document.getElementById('jsStatus').className = 'status-value text-success';
                log('‚úÖ JavaScript Dependencies ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } else {
                document.getElementById('jsStatus').innerHTML = '‚ùå Missing';
                document.getElementById('jsStatus').className = 'status-value text-danger';
                log('‚ùå JavaScript Dependencies ‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡∏û‡∏ö', 'error');
            }
        }

        // Test Login
        async function testLogin() {
            const username = document.getElementById('testUsername').value.trim();
            const password = document.getElementById('testPassword').value.trim();
            
            if (!username || !password) {
                log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà username ‡πÅ‡∏•‡∏∞ password', 'error');
                return;
            }

            try {
                log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Login: ${username}`, 'info');
                
                // Check if AuthAPI exists
                if (!window.AuthAPI) {
                    throw new Error('AuthAPI ‡πÑ‡∏°‡πà‡∏û‡∏ö - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î auth.js');
                }
                
                const user = await window.AuthAPI.login(username, password);
                
                log('‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                log(`User: ${JSON.stringify(user)}`, 'info');
                
                document.getElementById('loginTestResult').innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong><br>
                        Username: ${user.username}<br>
                        Role: ${user.role}<br>
                        Group ID: ${user.groupId || 'N/A'}
                    </div>
                `;
                
                document.getElementById('authStatus').innerHTML = '‚úÖ Working';
                document.getElementById('authStatus').className = 'status-value text-success';
                
            } catch (error) {
                log(`‚ùå Login ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
                
                document.getElementById('loginTestResult').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Login ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!</strong><br>
                        Error: ${error.message}
                    </div>
                `;
                
                document.getElementById('authStatus').innerHTML = '‚ùå Failed';
                document.getElementById('authStatus').className = 'status-value text-danger';
            }
        }

        // Test QR Code
        async function testQRCode() {
            const qrCode = document.getElementById('testQRCode').value.trim();
            
            if (!qrCode) {
                log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà QR Code', 'error');
                return;
            }

            try {
                log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö QR Code: ${qrCode}`, 'info');
                
                // Check if QRAPI exists
                if (!window.QRAPI) {
                    throw new Error('QRAPI ‡πÑ‡∏°‡πà‡∏û‡∏ö - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î api.js');
                }
                
                // Validate QR Code format
                if (!window.Utils || !window.Utils.validateQRCode(qrCode)) {
                    throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö QR Code ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
                
                const result = await window.QRAPI.searchByQRCode(qrCode);
                
                if (result.success) {
                    log('‚úÖ QR Code ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    log(`Data: ${JSON.stringify(result.data)}`, 'info');
                    
                    document.getElementById('qrTestResult').innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ QR Code ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ!</strong><br>
                            QR Code: ${result.data.qrCode}<br>
                            Group: ${result.data.groupName}<br>
                            Farmer: ${result.data.farmerName}
                        </div>
                    `;
                    
                    document.getElementById('qrStatus').innerHTML = '‚úÖ Working';
                    document.getElementById('qrStatus').className = 'status-value text-success';
                } else {
                    throw new Error(result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR Code');
                }
                
            } catch (error) {
                log(`‚ùå QR Code ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
                
                document.getElementById('qrTestResult').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è QR Code ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!</strong><br>
                        Error: ${error.message}<br>
                        ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                    </div>
                `;
                
                document.getElementById('qrStatus').innerHTML = '‚ö†Ô∏è No Data';
                document.getElementById('qrStatus').className = 'status-value text-warning';
            }
        }

        // Auto-run basic tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Debug Helper ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', 'info');
            
            // Auto-detect API URL from CONFIG
            if (window.CONFIG && window.CONFIG.API_BASE_URL) {
                document.getElementById('apiUrl').value = window.CONFIG.API_BASE_URL;
                log(`üìã ‡∏û‡∏ö API URL ‡πÉ‡∏ô CONFIG: ${window.CONFIG.API_BASE_URL}`, 'info');
            }
            
            // Auto-test JS dependencies
            setTimeout(() => {
                testJSDependencies();
            }, 1000);
        });

        // Check camera support
        function checkCameraSupport() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                log('‚úÖ Camera API ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', 'success');
                return true;
            } else {
                log('‚ùå Camera API ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', 'error');
                return false;
            }
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            log(`‚ùå JavaScript Error: ${event.error.message} in ${event.filename}:${event.lineno}`, 'error');
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            log(`‚ùå Unhandled Promise Rejection: ${event.reason}`, 'error');
        });

        // Console override to capture logs
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };

        console.log = function(...args) {
            log(args.join(' '), 'info');
            originalConsole.log.apply(console, args);
        };

        console.error = function(...args) {
            log(args.join(' '), 'error');
            originalConsole.error.apply(console, args);
        };

        console.warn = function(...args) {
            log(args.join(' '), 'warning');
            originalConsole.warn.apply(console, args);
        };
    </script>
</body>
</html>
