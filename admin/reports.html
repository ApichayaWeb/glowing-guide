<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานและสถิติ - ระบบสอบย้อนกลับผักอุดร</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
    <!-- Date Range Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
    <!-- Enhanced Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top custom-navbar">
        <div class="container-fluid px-4">
            <!-- Brand -->
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <div class="brand-icon me-3">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="brand-text">
                    <div class="brand-title">ระบบสอบย้อนกลับผักอุดร</div>
                    <div class="brand-subtitle">Admin Dashboard</div>
                </div>
            </a>

            <!-- Mobile Toggle -->
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navigation Items -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- Main Navigation -->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item mx-1">
                        <a class="nav-link nav-link-custom" href="dashboard.html">
                            <i class="fas fa-tachometer-alt nav-icon"></i>
                            <span class="nav-text">แผงควบคุม</span>
                        </a>
                    </li>
                    <li class="nav-item mx-1">
                        <a class="nav-link nav-link-custom" href="manage-groups.html">
                            <i class="fas fa-users nav-icon"></i>
                            <span class="nav-text">จัดการกลุ่ม</span>
                        </a>
                    </li>
                    <li class="nav-item mx-1">
                        <a class="nav-link nav-link-custom active" href="reports.html">
                            <i class="fas fa-chart-bar nav-icon"></i>
                            <span class="nav-text">รายงาน</span>
                        </a>
                    </li>
                </ul>

                <!-- User Menu -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-menu" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-info d-flex align-items-center">
                                <div class="user-avatar me-2">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="user-details d-none d-lg-block">
                                    <div class="user-name user-display">Admin</div>
                                    <div class="user-role">ผู้ดูแลระบบ</div>
                                </div>
                                <span class="d-lg-none ms-2">Admin (ผู้ดูแลระบบ)</span>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end user-dropdown">
                            <li class="dropdown-header">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-circle me-2 text-success"></i>
                                    <div>
                                        <div class="fw-bold user-display">Admin</div>
                                        <small class="text-muted">ผู้ดูแลระบบ</small>
                                    </div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item dropdown-item-custom" href="#" onclick="changePassword()">
                                    <i class="fas fa-key me-3 text-primary"></i>
                                    <span>เปลี่ยนรหัสผ่าน</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item dropdown-item-custom" href="#">
                                    <i class="fas fa-cog me-3 text-secondary"></i>
                                    <span>ตั้งค่าบัญชี</span>
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item dropdown-item-custom logout-btn" href="#" onclick="AuthAPI.confirmLogout()">
                                    <i class="fas fa-sign-out-alt me-3 text-danger"></i>
                                    <span>ออกจากระบบ</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="page-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h1 class="page-title">
                            <i class="fas fa-chart-bar me-3"></i>รายงานและสถิติ
                        </h1>
                        <p class="page-subtitle">วิเคราะห์ข้อมูลและสร้างรายงานระบบ</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                            <i class="fas fa-download me-2"></i>ส่งออกรายงาน
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filter Panel -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>ตัวกรองข้อมูล
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filterForm">
                        <div class="row g-3">
                            <!-- Date Range -->
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-calendar me-1"></i>ช่วงวันที่
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="dateRange" 
                                           placeholder="เลือกช่วงวันที่" readonly>
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar-alt"></i>
                                    </span>
                                </div>
                            </div>

                            <!-- Group Filter -->
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="fas fa-users me-1"></i>กลุ่มเกษตรกร
                                </label>
                                <select class="form-select" id="groupFilter">
                                    <option value="">ทุกกลุ่ม</option>
                                    <option value="group01">กลุ่มที่ 01 - เกษตรกรผักปลอดภัย</option>
                                    <option value="group02">กลุ่มที่ 02 - เกษตรกรอินทรีย์</option>
                                    <option value="group03">กลุ่มที่ 03 - เกษตรกรเศรษฐกิจพอเพียง</option>
                                </select>
                            </div>

                            <!-- Status Filter -->
                            <div class="col-md-2">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on me-1"></i>สถานะ
                                </label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">ทั้งหมด</option>
                                    <option value="active">เปิดใช้งาน</option>
                                    <option value="inactive">ปิดใช้งาน</option>
                                </select>
                            </div>

                            <!-- Crop Type Filter -->
                            <div class="col-md-2">
                                <label class="form-label">
                                    <i class="fas fa-seedling me-1"></i>ประเภทผัก
                                </label>
                                <select class="form-select" id="cropFilter">
                                    <option value="">ทุกประเภท</option>
                                    <option value="leafy">ผักใบ</option>
                                    <option value="fruit">ผักผล</option>
                                    <option value="root">ผักราก</option>
                                    <option value="herb">สมุนไพร</option>
                                </select>
                            </div>

                            <!-- Apply Button -->
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-success w-100" data-loading="กำลังโหลด...">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Report Categories -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">หมวดหมู่รายงาน</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- System Overview -->
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="report-category-card" data-report="system">
                                        <div class="report-icon">
                                            <i class="fas fa-chart-pie"></i>
                                        </div>
                                        <h6>รายงานสรุประบบ</h6>
                                        <p class="small text-muted">ภาพรวมระบบทั้งหมด</p>
                                    </div>
                                </div>

                                <!-- Groups Report -->
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="report-category-card" data-report="groups">
                                        <div class="report-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h6>รายงานกลุ่มเกษตรกร</h6>
                                        <p class="small text-muted">ข้อมูลกลุ่มเกษตรกร</p>
                                    </div>
                                </div>

                                <!-- Farmers Report -->
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="report-category-card" data-report="farmers">
                                        <div class="report-icon">
                                            <i class="fas fa-user-friends"></i>
                                        </div>
                                        <h6>รายงานเกษตรกร</h6>
                                        <p class="small text-muted">ข้อมูลเกษตรกรรายย่อย</p>
                                    </div>
                                </div>

                                <!-- QR Codes Report -->
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="report-category-card" data-report="qrcodes">
                                        <div class="report-icon">
                                            <i class="fas fa-qrcode"></i>
                                        </div>
                                        <h6>รายงาน QR Code</h6>
                                        <p class="small text-muted">สถิติ QR Code</p>
                                    </div>
                                </div>

                                <!-- Usage Analytics -->
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="report-category-card" data-report="usage">
                                        <div class="report-icon">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <h6>รายงานการใช้งาน</h6>
                                        <p class="small text-muted">สถิติการใช้งานระบบ</p>
                                    </div>
                                </div>

                                <!-- Scan Analytics -->
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <div class="report-category-card" data-report="scans">
                                        <div class="report-icon">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        <h6>รายงานการสแกน</h6>
                                        <p class="small text-muted">สถิติการสแกน QR</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Content Area -->
            <div class="row">
                <!-- Charts Section -->
                <div class="col-lg-8">
                    <!-- Charts Row 1 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-chart-bar me-2"></i>จำนวนกลุ่มเกษตรกร
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="groupsChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-chart-line me-2"></i>การเติบโตรายเดือน
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="growthChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 2 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-chart-pie me-2"></i>สัดส่วนประเภทผัก
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="cropTypesChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-chart-area me-2"></i>สถิติการสแกน QR
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="scanStatsChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-table me-2"></i>รายละเอียดข้อมูล
                            </h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-cog me-1"></i>ตัวเลือก
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportTableData('pdf')">
                                        <i class="fas fa-file-pdf me-2"></i>ส่งออก PDF
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportTableData('excel')">
                                        <i class="fas fa-file-excel me-2"></i>ส่งออก Excel
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportTableData('csv')">
                                        <i class="fas fa-file-csv me-2"></i>ส่งออก CSV
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="reportTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ลำดับ</th>
                                            <th>กลุ่มเกษตรกร</th>
                                            <th>จำนวนเกษตรกร</th>
                                            <th>QR Code</th>
                                            <th>การสแกน</th>
                                            <th>สถานะ</th>
                                            <th>วันที่สร้าง</th>
                                            <th>การดำเนินการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportTableBody">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav aria-label="Table pagination">
                                <ul class="pagination justify-content-center mt-3" id="tablePagination">
                                    <!-- Pagination will be generated here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Statistics Sidebar -->
                <div class="col-lg-4">
                    <!-- Quick Stats -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>สถิติด่วน
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="stat-item text-center">
                                        <div class="stat-value text-primary">
                                            <span id="totalGroups">12</span>
                                        </div>
                                        <div class="stat-label">กลุ่มเกษตรกร</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-item text-center">
                                        <div class="stat-value text-success">
                                            <span id="totalFarmers">248</span>
                                        </div>
                                        <div class="stat-label">เกษตรกร</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-item text-center">
                                        <div class="stat-value text-warning">
                                            <span id="totalQRCodes">186</span>
                                        </div>
                                        <div class="stat-label">QR Codes</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-item text-center">
                                        <div class="stat-value text-info">
                                            <span id="totalScans">1,245</span>
                                        </div>
                                        <div class="stat-label">การสแกน</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-clock me-2"></i>กิจกรรมล่าสุด
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="activity-list" id="recentActivity">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Top Performing Groups -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-trophy me-2"></i>กลุ่มยอดนิยม
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="top-groups-list" id="topGroups">
                                <!-- Top groups will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-download me-2"></i>ส่งออกรายงาน
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="exportForm">
                        <div class="row g-3">
                            <!-- Export Type -->
                            <div class="col-md-6">
                                <label class="form-label">ประเภทการส่งออก</label>
                                <div class="export-type-grid">
                                    <label class="export-type-card">
                                        <input type="radio" name="exportType" value="pdf" checked>
                                        <div class="card-content">
                                            <i class="fas fa-file-pdf text-danger"></i>
                                            <span>PDF Report</span>
                                            <small>รายงานพร้อมกราฟ</small>
                                        </div>
                                    </label>
                                    <label class="export-type-card">
                                        <input type="radio" name="exportType" value="excel">
                                        <div class="card-content">
                                            <i class="fas fa-file-excel text-success"></i>
                                            <span>Excel</span>
                                            <small>สเปรดชีต</small>
                                        </div>
                                    </label>
                                    <label class="export-type-card">
                                        <input type="radio" name="exportType" value="csv">
                                        <div class="card-content">
                                            <i class="fas fa-file-csv text-primary"></i>
                                            <span>CSV</span>
                                            <small>ข้อมูลดิบ</small>
                                        </div>
                                    </label>
                                    <label class="export-type-card">
                                        <input type="radio" name="exportType" value="email">
                                        <div class="card-content">
                                            <i class="fas fa-envelope text-warning"></i>
                                            <span>Email</span>
                                            <small>ส่งทางอีเมล</small>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Report Sections -->
                            <div class="col-md-6">
                                <label class="form-label">เลือกหัวข้อรายงาน</label>
                                <div class="report-sections">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="overview" 
                                               id="includeOverview" checked>
                                        <label class="form-check-label" for="includeOverview">
                                            ภาพรวมระบบ
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="groups" 
                                               id="includeGroups" checked>
                                        <label class="form-check-label" for="includeGroups">
                                            ข้อมูลกลุ่มเกษตรกร
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="farmers" 
                                               id="includeFarmers">
                                        <label class="form-check-label" for="includeFarmers">
                                            ข้อมูลเกษตรกร
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="qrcodes" 
                                               id="includeQRCodes">
                                        <label class="form-check-label" for="includeQRCodes">
                                            สถิติ QR Code
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="analytics" 
                                               id="includeAnalytics">
                                        <label class="form-check-label" for="includeAnalytics">
                                            การวิเคราะห์
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Email Options (shown when email is selected) -->
                            <div class="col-12" id="emailOptions" style="display: none;">
                                <hr>
                                <h6>ตัวเลือกการส่งอีเมล</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">อีเมลผู้รับ</label>
                                        <input type="email" class="form-control" id="recipientEmail" 
                                               placeholder="example@email.com">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">หัวข้ออีเมล</label>
                                        <input type="text" class="form-control" id="emailSubject" 
                                               value="รายงานระบบสอบย้อนกลับผักอุดร">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">ข้อความ</label>
                                        <textarea class="form-control" id="emailMessage" rows="3"
                                                  placeholder="เรียน ท่านผู้รับ กรุณาตรวจสอบรายงานในไฟล์แนบ"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="executeExport()" data-loading="กำลังส่งออก...">
                        <i class="fas fa-download me-2"></i>ส่งออก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">กำลังโหลด...</span>
            </div>
            <h5>กำลังสร้างรายงาน...</h5>
            <p class="text-muted">กรุณารอสักครู่</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Date Range Picker -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Custom Scripts -->
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/mobile-optimizations.js"></script>
    <script src="../assets/js/admin-reports.js"></script>

    <script>
        // Initialize page on load
        document.addEventListener('DOMContentLoaded', function() {
            // Check admin permission first
            const currentUser = AuthAPI.getCurrentUser();
            console.log('Admin reports - Current user:', currentUser);
            
            if (!currentUser || !currentUser.role || currentUser.role.toString().trim().toLowerCase() !== 'admin') {
                console.error('Permission denied: Admin role required for reports');
                Utils.showError('ไม่มีสิทธิ์', 'คุณต้องมีสิทธิ์ผู้ดูแลระบบเท่านั้น');
                setTimeout(() => window.location.href = '../login.html', 2000);
                return;
            }
            
            // Initialize date range picker
            initializeDateRangePicker();
            
            // Initialize charts
            initializeCharts();
            
            // Load initial data
            loadReportData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize error handling
            initializeErrorHandling();
            
            console.log('Admin Reports page initialized');
        });

        /**
         * Initialize date range picker
         */
        function initializeDateRangePicker() {
            const dateRangeInput = document.getElementById('dateRange');
            if (dateRangeInput) {
                $(dateRangeInput).daterangepicker({
                    locale: {
                        format: 'DD/MM/YYYY',
                        separator: ' - ',
                        applyLabel: 'เลือก',
                        cancelLabel: 'ยกเลิก',
                        fromLabel: 'จาก',
                        toLabel: 'ถึง',
                        customRangeLabel: 'กำหนดเอง',
                        weekLabel: 'สัปดาห์',
                        daysOfWeek: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'],
                        monthNames: [
                            'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                            'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
                        ],
                        firstDay: 1
                    },
                    ranges: {
                        'วันนี้': [moment(), moment()],
                        'เมื่อวาน': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        '7 วันที่แล้ว': [moment().subtract(6, 'days'), moment()],
                        '30 วันที่แล้ว': [moment().subtract(29, 'days'), moment()],
                        'เดือนนี้': [moment().startOf('month'), moment().endOf('month')],
                        'เดือนที่แล้ว': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    },
                    startDate: moment().subtract(29, 'days'),
                    endDate: moment()
                });

                $(dateRangeInput).on('apply.daterangepicker', function(ev, picker) {
                    loadReportData();
                });
            }
        }

        /**
         * Initialize error handling
         */
        function initializeErrorHandling() {
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled promise rejection:', event.reason);
                event.preventDefault();
                
                if (!document.querySelector('.swal2-container')) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'เกิดข้อผิดพลาดที่ไม่คาดคิด กรุณาลองใหม่อีกครั้ง',
                        confirmButtonColor: '#198754'
                    });
                }
            });
        }
    </script>

    <style>
        /* Enhanced Navbar Styles */
        .custom-navbar {
            background: linear-gradient(135deg, #2c5530 0%, #28a745 50%, #20c997 100%);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            padding: 0.5rem 0;
        }

        .brand-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #28a745;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .brand-text {
            line-height: 1.2;
        }

        .brand-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }

        .brand-subtitle {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.8);
            font-weight: 400;
        }

        .nav-link-custom {
            padding: 0.75rem 1rem !important;
            margin: 0 0.25rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.9) !important;
            position: relative;
            overflow: hidden;
        }

        .nav-link-custom::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 10px;
        }

        .nav-link-custom:hover::before,
        .nav-link-custom.active::before {
            opacity: 1;
        }

        .nav-link-custom:hover,
        .nav-link-custom.active {
            color: white !important;
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-icon {
            width: 18px;
            text-align: center;
            margin-right: 0.5rem;
        }

        .nav-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .user-menu {
            padding: 0.5rem 1rem !important;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.9) !important;
        }

        .user-menu:hover {
            background: rgba(255,255,255,0.1);
            color: white !important;
        }

        .user-avatar i {
            font-size: 2rem;
            color: #fff;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            line-height: 1.2;
        }

        .user-role {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.8);
            line-height: 1.2;
        }

        .user-dropdown {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 0.5rem 0;
            margin-top: 0.5rem;
            min-width: 280px;
        }

        .dropdown-header {
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px 10px 0 0;
            margin-bottom: 0.5rem;
        }

        .dropdown-item-custom {
            padding: 0.75rem 1.25rem;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 0.25rem 0.5rem;
        }

        .dropdown-item-custom:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateX(5px);
        }

        .navbar-toggler {
            padding: 0.5rem;
            border-radius: 8px;
        }

        .navbar-toggler:focus {
            box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
        }

        @media (max-width: 768px) {
            .brand-title {
                font-size: 0.95rem;
            }

            .brand-subtitle {
                font-size: 0.7rem;
            }

            .nav-link-custom {
                margin: 0.25rem 0;
            }

            .user-dropdown {
                min-width: 250px;
            }
        }

        @media (max-width: 576px) {
            .brand-text {
                display: none;
            }
        }
    </style>
</body>
</html>