<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ดูข้อมูลของฉัน - ระบบสอบย้อนกลับผักอุดร</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../assets/css/main.css" rel="stylesheet">
    
    <style>
        .data-section {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        }
        
        .section-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            margin: -1rem -1rem 1rem -1rem;
            padding: 1rem;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        
        .data-row {
            border-bottom: 1px solid #e9ecef;
            padding: 0.75rem 0;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            font-weight: 600;
            color: #495057;
        }
        
        .data-value {
            color: #212529;
        }
        
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .image-item {
            position: relative;
            overflow: hidden;
            border-radius: 0.375rem;
            border: 1px solid #dee2e6;
        }
        
        .image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .image-item:hover img {
            transform: scale(1.05);
        }
        
        .status-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            z-index: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .filter-tabs {
            background: #f8f9fa;
            border-radius: 0.375rem;
            padding: 0.25rem;
            margin-bottom: 2rem;
        }
        
        .filter-tab {
            border: none;
            background: transparent;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            transition: all 0.3s ease;
        }
        
        .filter-tab.active {
            background: white;
            color: #28a745;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
        }
        
        .qr-display {
            background: white;
            padding: 2rem;
            border-radius: 0.375rem;
            text-align: center;
            border: 2px dashed #28a745;
        }
        
        .print-section {
            background: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container">
            <a class="navbar-brand text-success" href="../index.html">
                <i class="fas fa-leaf me-2"></i>ผักอุดรคลีน
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home me-1"></i>แดชบอร์ด
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="data-entry.html">
                            <i class="fas fa-edit me-1"></i>กรอกข้อมูล
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="view-data.html">
                            <i class="fas fa-eye me-1"></i>ดูข้อมูล
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i><span id="userName">เกษตรกร</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="dashboard.html">
                                <i class="fas fa-home me-2"></i>แดชบอร์ด
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>ออกจากระบบ
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body bg-info text-white rounded">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="mb-2">
                                    <i class="fas fa-eye me-2"></i>
                                    ข้อมูลผลผลิตของฉัน
                                </h2>
                                <p class="mb-0">
                                    เกษตรกร: <span id="farmerName">-</span> | 
                                    รหัสแปลง: <span id="plotCode">-</span> |
                                    กลุ่ม: <span id="groupName">-</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="fs-6">
                                    <i class="fas fa-clock me-1"></i>
                                    อัปเดตล่าสุด: <span id="lastUpdate">-</span>
                                </div>
                                <button class="btn btn-light btn-sm mt-2" onclick="window.print()">
                                    <i class="fas fa-print me-1"></i>พิมพ์ข้อมูล
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-tabs">
                    <div class="d-flex flex-wrap">
                        <button class="filter-tab active" onclick="showAllSections()">
                            <i class="fas fa-list me-1"></i>ทั้งหมด
                        </button>
                        <button class="filter-tab" onclick="showSection('summary')">
                            <i class="fas fa-chart-pie me-1"></i>สรุปข้อมูล
                        </button>
                        <button class="filter-tab" onclick="showSection('qr')">
                            <i class="fas fa-qrcode me-1"></i>QR Code
                        </button>
                        <button class="filter-tab" onclick="showOnlyCompleted()">
                            <i class="fas fa-check-circle me-1"></i>ส่วนที่เสร็จแล้ว
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div id="summarySection" class="row mb-4">
            <div class="col-12">
                <div class="card summary-card border-0 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>สรุปข้อมูลโดยรวม
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="text-center">
                                    <div class="fs-2 text-success mb-2">
                                        <i class="fas fa-percentage"></i>
                                    </div>
                                    <h4 class="text-success" id="completionRate">0%</h4>
                                    <small class="text-muted">ความสมบูรณ์ข้อมูล</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="text-center">
                                    <div class="fs-2 text-primary mb-2">
                                        <i class="fas fa-tasks"></i>
                                    </div>
                                    <h4 class="text-primary" id="completedSections">0/6</h4>
                                    <small class="text-muted">ส่วนที่เสร็จแล้ว</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="text-center">
                                    <div class="fs-2 text-warning mb-2">
                                        <i class="fas fa-calendar"></i>
                                    </div>
                                    <h4 class="text-warning" id="plantingDate">-</h4>
                                    <small class="text-muted">วันที่ปลูก</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="text-center">
                                    <div class="fs-2 text-info mb-2">
                                        <i class="fas fa-weight"></i>
                                    </div>
                                    <h4 class="text-info" id="harvestQuantity">-</h4>
                                    <small class="text-muted">ปริมาณผลผลิต (กก.)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Section -->
        <div id="qrSection" class="row mb-4" style="display: none;">
            <div class="col-lg-6 mx-auto">
                <div class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-qrcode me-2"></i>QR Code แปลง
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="qr-display" id="qrDisplay">
                            <div class="text-muted">
                                <i class="fas fa-spinner fa-spin fs-2 mb-3"></i>
                                <p>กำลังโหลด QR Code...</p>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-success me-2" onclick="downloadQRCode()">
                                <i class="fas fa-download me-1"></i>ดาวน์โหลด
                            </button>
                            <button class="btn btn-primary" onclick="generateSearchCode()">
                                <i class="fas fa-search me-1"></i>สร้างรหัสค้นหา
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Sections -->
        <div id="dataSections">
            <!-- Section 1: ข้อมูลพื้นฐานแปลง -->
            <div class="row mb-4 data-section-row" data-section="1">
                <div class="col-12">
                    <div class="card data-section border-0 shadow-sm">
                        <div class="card-body">
                            <div class="section-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-map me-2"></i>ส่วนที่ 1: ข้อมูลพื้นฐานแปลง
                                </h5>
                                <div class="status-badge">
                                    <span class="badge bg-light" id="section1Status">ไม่มีข้อมูล</span>
                                </div>
                            </div>
                            <div id="section1Data">
                                <!-- Data will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: การเตรียมดิน -->
            <div class="row mb-4 data-section-row" data-section="2">
                <div class="col-12">
                    <div class="card data-section border-0 shadow-sm">
                        <div class="card-body">
                            <div class="section-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-tractor me-2"></i>ส่วนที่ 2: การเตรียมดิน
                                </h5>
                                <div class="status-badge">
                                    <span class="badge bg-light" id="section2Status">ไม่มีข้อมูล</span>
                                </div>
                            </div>
                            <div id="section2Data">
                                <!-- Data will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: การปลูก -->
            <div class="row mb-4 data-section-row" data-section="3">
                <div class="col-12">
                    <div class="card data-section border-0 shadow-sm">
                        <div class="card-body">
                            <div class="section-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-seedling me-2"></i>ส่วนที่ 3: การปลูก
                                </h5>
                                <div class="status-badge">
                                    <span class="badge bg-light" id="section3Status">ไม่มีข้อมูล</span>
                                </div>
                            </div>
                            <div id="section3Data">
                                <!-- Data will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: การดูแลรักษา -->
            <div class="row mb-4 data-section-row" data-section="4">
                <div class="col-12">
                    <div class="card data-section border-0 shadow-sm">
                        <div class="card-body">
                            <div class="section-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-tools me-2"></i>ส่วนที่ 4: การดูแลรักษา
                                </h5>
                                <div class="status-badge">
                                    <span class="badge bg-light" id="section4Status">ไม่มีข้อมูล</span>
                                </div>
                            </div>
                            <div id="section4Data">
                                <!-- Data will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: การเก็บเกี่ยว -->
            <div class="row mb-4 data-section-row" data-section="5">
                <div class="col-12">
                    <div class="card data-section border-0 shadow-sm">
                        <div class="card-body">
                            <div class="section-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-cut me-2"></i>ส่วนที่ 5: การเก็บเกี่ยว
                                </h5>
                                <div class="status-badge">
                                    <span class="badge bg-light" id="section5Status">ไม่มีข้อมูล</span>
                                </div>
                            </div>
                            <div id="section5Data">
                                <!-- Data will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 6: หลังการเก็บเกี่ยว -->
            <div class="row mb-4 data-section-row" data-section="6">
                <div class="col-12">
                    <div class="card data-section border-0 shadow-sm">
                        <div class="card-body">
                            <div class="section-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-shipping-fast me-2"></i>ส่วนที่ 6: หลังการเก็บเกี่ยว
                                </h5>
                                <div class="status-badge">
                                    <span class="badge bg-light" id="section6Status">ไม่มีข้อมูล</span>
                                </div>
                            </div>
                            <div id="section6Data">
                                <!-- Data will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Print Section -->
        <div class="print-section d-print-none">
            <div class="row">
                <div class="col-md-6">
                    <h6>
                        <i class="fas fa-download me-2"></i>ดาวน์โหลดข้อมูล
                    </h6>
                    <button class="btn btn-success me-2" onclick="downloadReport()">
                        <i class="fas fa-file-pdf me-1"></i>รายงาน PDF
                    </button>
                    <button class="btn btn-info" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-1"></i>ไฟล์ Excel
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <h6>
                        <i class="fas fa-edit me-2"></i>จัดการข้อมูล
                    </h6>
                    <a href="data-entry.html" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i>แก้ไขข้อมูล
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Code Modal -->
    <div class="modal fade" id="searchCodeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-search me-2"></i>สร้างรหัสค้นหา
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="searchCodeForm">
                        <div class="mb-3">
                            <label for="shipDate" class="form-label">วันที่จัดส่ง</label>
                            <input type="date" class="form-control" id="shipDate" required>
                        </div>
                        <div id="searchCodeResult" class="d-none">
                            <div class="alert alert-success">
                                <h6>รหัสค้นหาของคุณ:</h6>
                                <h4 class="text-center font-monospace" id="generatedSearchCode"></h4>
                                <div class="text-center mt-3">
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="copySearchCode()">
                                        <i class="fas fa-copy me-1"></i>คัดลอก
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="generateCode()">
                        <i class="fas fa-cog me-1"></i>สร้างรหัส
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="d-none">
        <div class="spinner-overlay">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/api.js"></script>
    
    <script>
        let farmerData = null;
        
        const fieldLabels = {
            // Section 1
            plotSize: 'ขนาดแปลง (ไร่)',
            soilType: 'ชนิดดิน',
            waterSource: 'แหล่งน้ำ',
            plotLocation: 'ที่ตั้งแปลง',
            plotHistory: 'ประวัติการใช้แปลง',
            
            // Section 2
            soilPrepDate: 'วันที่เตรียมดิน',
            soilPrepMethod: 'วิธีการเตรียมดิน',
            organicMatter: 'ปุ่ยอินทรีย์ที่ใช้',
            organicAmount: 'ปริมาณปุ่ยอินทรีย์ (กก./ไร่)',
            soilPH: 'ค่า pH ของดิน',
            liming: 'การใส่ปูนขาว',
            soilPrepNotes: 'หมายเหตุการเตรียมดิน',
            
            // Section 3
            plantingDate: 'วันที่ปลูก',
            vegetableType: 'ชนิดผัก',
            variety: 'พันธุ์',
            seedSource: 'แหล่งที่มาของเมล็ดพันธุ์',
            plantingMethod: 'วิธีการปลูก',
            plantSpacing: 'ระยะปลูก (ซม.)',
            plantDensity: 'ความหนาแน่นการปลูก (ต้น/ไร่)',
            mulching: 'การคลุมดิน',
            plantingNotes: 'หมายเหตุการปลูก',
            
            // Section 4
            wateringFreq: 'ความถี่การรดน้ำ',
            wateringMethod: 'วิธีการรดน้ำ',
            fertilizerType1: 'ปุ่ยชนิดที่ 1',
            fertilizerAmount1: 'ปริมาณปุ่ยชนิดที่ 1 (กก./ไร่)',
            fertilizerDate1: 'วันที่ใส่ปุ่ยชนิดที่ 1',
            fertilizerType2: 'ปุ่ยชนิดที่ 2',
            fertilizerAmount2: 'ปริมาณปุ่ยชนิดที่ 2 (กก./ไร่)',
            fertilizerDate2: 'วันที่ใส่ปุ่ยชนิดที่ 2',
            pestProblem: 'ปัญหาที่พบ',
            pestSolution: 'วิธีการแก้ไข',
            chemicalUsed: 'สารเคมีที่ใช้',
            chemicalDate: 'วันที่ใช้สารเคมี',
            careNotes: 'หมายเหตุการดูแลรักษา',
            
            // Section 5
            harvestDate: 'วันที่เก็บเกี่ยว',
            harvestMethod: 'วิธีการเก็บเกี่ยว',
            harvestQuantity: 'ปริมาณผลผลิต (กก.)',
            harvestTime: 'เวลาที่เก็บเกี่ยว',
            harvestCondition: 'สภาพอากาศขณะเก็บเกี่ยว',
            plantAge: 'อายุพืช (วัน)',
            qualityGrade: 'เกรดคุณภาพ',
            packaging: 'การบรรจุ',
            harvestNotes: 'หมายเหตุการเก็บเกี่ยว',
            
            // Section 6
            washingMethod: 'วิธีการล้าง',
            dryingMethod: 'วิธีการควบคุมความชื้น',
            storageMethod: 'วิธีการเก็บรักษา',
            storageTemp: 'อุณหภูมิการเก็บรักษา (°C)',
            transportMethod: 'วิธีการขนส่ง',
            destination: 'จุดหมายปลายทาง',
            shippingDate: 'วันที่จัดส่ง',
            shelfLife: 'อายุการเก็บรักษา (วัน)',
            postHarvestNotes: 'หมายเหตุหลังการเก็บเกี่ยว'
        };

        // Page initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            try {
                // Check authentication
                if (!AuthAPI.isLoggedIn()) {
                    window.location.href = '../login.html';
                    return;
                }

                const user = AuthAPI.getCurrentUser();
                if (!user.role || user.role.toString().trim().toLowerCase() !== 'farmer') {
                    AuthAPI.logout();
                    return;
                }

                // Update user info
                updateUserInfo(user);
                
                // Load farmer data
                await loadFarmerData();
                
                // Load QR Code
                loadQRCode();

            } catch (error) {
                console.error('Initialization error:', error);
                Utils.showError('ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่อีกครั้ง');
            }
        }

        function updateUserInfo(user) {
            document.getElementById('userName').textContent = user.fullName || user.username;
            document.getElementById('farmerName').textContent = user.fullName || user.username;
            document.getElementById('plotCode').textContent = user.plotCode || '-';
            document.getElementById('groupName').textContent = user.groupName || '-';
        }

        async function loadFarmerData() {
            try {
                Utils.showLoading('กำลังโหลดข้อมูล...');
                
                const user = AuthAPI.getCurrentUser();
                const result = await FarmerAPI.getFarmerData(user.farmerId);
                
                Utils.hideLoading();
                
                if (result.success) {
                    farmerData = result.data;
                    
                    // Update last update time
                    if (farmerData.lastUpdate) {
                        document.getElementById('lastUpdate').textContent = 
                            new Date(farmerData.lastUpdate).toLocaleDateString('th-TH');
                    }
                    
                    // Load all section data
                    loadAllSectionData();
                    
                    // Update summary
                    updateSummary();
                    
                } else {
                    showEmptyState();
                }
            } catch (error) {
                Utils.hideLoading();
                console.error('Load farmer data error:', error);
                showEmptyState();
            }
        }

        function loadAllSectionData() {
            for (let i = 1; i <= 6; i++) {
                loadSectionData(i);
            }
        }

        function loadSectionData(sectionNumber) {
            const sectionData = farmerData?.sections?.[`section${sectionNumber}`];
            const container = document.getElementById(`section${sectionNumber}Data`);
            const statusBadge = document.getElementById(`section${sectionNumber}Status`);
            
            if (!sectionData || Object.keys(sectionData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox fs-1 mb-3"></i>
                        <p>ยังไม่มีข้อมูลในส่วนนี้</p>
                        <a href="data-entry.html" class="btn btn-primary btn-sm">
                            <i class="fas fa-edit me-1"></i>เริ่มกรอกข้อมูล
                        </a>
                    </div>
                `;
                statusBadge.className = 'badge bg-secondary';
                statusBadge.textContent = 'ไม่มีข้อมูล';
                return;
            }
            
            // Update status badge
            if (sectionData.completed) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'เสร็จสิ้น';
            } else {
                statusBadge.className = 'badge bg-warning';
                statusBadge.textContent = `${sectionData.progress || 0}% แบบร่าง`;
            }
            
            // Generate data HTML
            let dataHtml = '<div class="row">';
            
            Object.keys(sectionData).forEach((key, index) => {
                if (['completed', 'progress', 'lastUpdate'].includes(key)) return;
                
                const label = fieldLabels[key] || key;
                let value = sectionData[key];
                
                if (!value || value === '') {
                    value = '-';
                }
                
                // Format dates
                if (key.includes('Date') && value !== '-') {
                    value = new Date(value).toLocaleDateString('th-TH');
                }
                
                dataHtml += `
                    <div class="col-md-6">
                        <div class="data-row">
                            <div class="data-label">${label}:</div>
                            <div class="data-value">${value}</div>
                        </div>
                    </div>
                `;
            });
            
            dataHtml += '</div>';
            
            // Add images if exist
            if (sectionData.images && sectionData.images.length > 0) {
                dataHtml += `
                    <div class="mt-4">
                        <h6 class="mb-3">
                            <i class="fas fa-images me-2"></i>รูปภาพประกอบ
                        </h6>
                        <div class="image-gallery">
                `;
                
                sectionData.images.forEach(image => {
                    dataHtml += `
                        <div class="image-item">
                            <img src="${image.url}" alt="${image.name}" onclick="showImageModal('${image.url}', '${image.name}')">
                        </div>
                    `;
                });
                
                dataHtml += '</div></div>';
            }
            
            container.innerHTML = dataHtml;
        }

        function updateSummary() {
            let completedCount = 0;
            let totalProgress = 0;
            let plantingDate = '-';
            let harvestQuantity = '-';
            
            for (let i = 1; i <= 6; i++) {
                const section = farmerData?.sections?.[`section${i}`];
                if (section) {
                    if (section.completed) completedCount++;
                    totalProgress += (section.progress || 0);
                    
                    // Get planting date from section 3
                    if (i === 3 && section.plantingDate) {
                        plantingDate = new Date(section.plantingDate).toLocaleDateString('th-TH');
                    }
                    
                    // Get harvest quantity from section 5
                    if (i === 5 && section.harvestQuantity) {
                        harvestQuantity = section.harvestQuantity + ' กก.';
                    }
                }
            }
            
            const overallProgress = Math.round(totalProgress / 6);
            
            document.getElementById('completionRate').textContent = overallProgress + '%';
            document.getElementById('completedSections').textContent = `${completedCount}/6`;
            document.getElementById('plantingDate').textContent = plantingDate;
            document.getElementById('harvestQuantity').textContent = harvestQuantity;
        }

        async function loadQRCode() {
            try {
                const user = AuthAPI.getCurrentUser();
                const result = await FarmerAPI.getFarmerQRCode(user.farmerId);
                
                if (result.success) {
                    document.getElementById('qrDisplay').innerHTML = `
                        <img src="${result.qrCodeUrl}" alt="QR Code" class="img-fluid" style="max-width: 300px;">
                        <p class="mt-3 text-muted">
                            <strong>รหัสแปลง:</strong> ${user.plotCode || user.username}
                        </p>
                    `;
                } else {
                    document.getElementById('qrDisplay').innerHTML = `
                        <div class="text-muted">
                            <i class="fas fa-exclamation-triangle fs-2 mb-3"></i>
                            <p>ไม่สามารถโหลด QR Code ได้</p>
                            <button class="btn btn-primary btn-sm" onclick="loadQRCode()">
                                <i class="fas fa-refresh me-1"></i>ลองใหม่
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load QR Code error:', error);
                document.getElementById('qrDisplay').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle fs-2 mb-3"></i>
                        <p>เกิดข้อผิดพลาดในการโหลด QR Code</p>
                    </div>
                `;
            }
        }

        function showEmptyState() {
            document.getElementById('dataSections').innerHTML = `
                <div class="col-12">
                    <div class="empty-state">
                        <i class="fas fa-inbox fs-1 mb-3 text-muted"></i>
                        <h4 class="text-muted">ยังไม่มีข้อมูล</h4>
                        <p class="text-muted">กรุณาเริ่มกรอกข้อมูลผลผลิต 6 ส่วน</p>
                        <a href="data-entry.html" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i>เริ่มกรอกข้อมูล
                        </a>
                    </div>
                </div>
            `;
        }

        // Filter functions
        function showAllSections() {
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('summarySection').style.display = 'block';
            document.getElementById('qrSection').style.display = 'none';
            document.getElementById('dataSections').style.display = 'block';
            
            document.querySelectorAll('.data-section-row').forEach(row => {
                row.style.display = 'block';
            });
        }

        function showSection(type) {
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'summary') {
                document.getElementById('summarySection').style.display = 'block';
                document.getElementById('qrSection').style.display = 'none';
                document.getElementById('dataSections').style.display = 'none';
            } else if (type === 'qr') {
                document.getElementById('summarySection').style.display = 'none';
                document.getElementById('qrSection').style.display = 'block';
                document.getElementById('dataSections').style.display = 'none';
            }
        }

        function showOnlyCompleted() {
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('summarySection').style.display = 'block';
            document.getElementById('qrSection').style.display = 'none';
            document.getElementById('dataSections').style.display = 'block';
            
            document.querySelectorAll('.data-section-row').forEach((row, index) => {
                const section = farmerData?.sections?.[`section${index + 1}`];
                if (section && section.completed) {
                    row.style.display = 'block';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Export functions
        async function downloadReport() {
            try {
                Utils.showLoading('กำลังสร้างรายงาน...');
                
                const user = AuthAPI.getCurrentUser();
                const result = await ReportAPI.generateFarmerReport(user.farmerId);
                
                Utils.hideLoading();
                
                if (result.success) {
                    const link = document.createElement('a');
                    link.href = result.reportUrl;
                    link.download = `รายงานเกษตรกร_${user.plotCode || user.username}_${new Date().toISOString().split('T')[0]}.pdf`;
                    link.click();
                } else {
                    Utils.showError('ข้อผิดพลาด', result.message || 'ไม่สามารถสร้างรายงานได้');
                }
            } catch (error) {
                Utils.hideLoading();
                handleAPIError(error, 'ไม่สามารถสร้างรายงานได้');
            }
        }

        async function exportToExcel() {
            try {
                Utils.showLoading('กำลังสร้างไฟล์ Excel...');
                
                const user = AuthAPI.getCurrentUser();
                const result = await ReportAPI.exportToExcel('farmer', { farmerId: user.farmerId });
                
                Utils.hideLoading();
                
                if (result.success) {
                    const link = document.createElement('a');
                    link.href = result.fileUrl;
                    link.download = `ข้อมูลเกษตรกร_${user.plotCode || user.username}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    link.click();
                } else {
                    Utils.showError('ข้อผิดพลาด', result.message || 'ไม่สามารถสร้างไฟล์ Excel ได้');
                }
            } catch (error) {
                Utils.hideLoading();
                handleAPIError(error, 'ไม่สามารถสร้างไฟล์ Excel ได้');
            }
        }

        function downloadQRCode() {
            const qrImage = document.querySelector('#qrDisplay img');
            if (qrImage) {
                const link = document.createElement('a');
                link.href = qrImage.src;
                link.download = `QRCode_${AuthAPI.getCurrentUser().plotCode || 'farmer'}.png`;
                link.click();
            }
        }

        function generateSearchCode() {
            const modal = new bootstrap.Modal(document.getElementById('searchCodeModal'));
            modal.show();
            
            // Set default date to today
            document.getElementById('shipDate').value = new Date().toISOString().split('T')[0];
            
            // Hide previous result
            document.getElementById('searchCodeResult').classList.add('d-none');
        }

        async function generateCode() {
            try {
                const shipDate = document.getElementById('shipDate').value;
                if (!shipDate) {
                    Utils.showError('ข้อผิดพลาด', 'กรุณาเลือกวันที่จัดส่ง');
                    return;
                }

                Utils.showLoading('กำลังสร้างรหัสค้นหา...');
                
                const user = AuthAPI.getCurrentUser();
                const result = await FarmerAPI.generateSearchCode(user.farmerId, shipDate);
                
                Utils.hideLoading();
                
                if (result.success) {
                    document.getElementById('generatedSearchCode').textContent = result.searchCode;
                    document.getElementById('searchCodeResult').classList.remove('d-none');
                } else {
                    Utils.showError('ข้อผิดพลาด', result.message || 'ไม่สามารถสร้างรหัสค้นหาได้');
                }
            } catch (error) {
                Utils.hideLoading();
                handleAPIError(error, 'ไม่สามารถสร้างรหัสค้นหาได้');
            }
        }

        function copySearchCode() {
            const searchCode = document.getElementById('generatedSearchCode').textContent;
            navigator.clipboard.writeText(searchCode).then(() => {
                Utils.showSuccess('สำเร็จ', 'คัดลอกรหัสค้นหาแล้ว');
            });
        }

        function showImageModal(imageUrl, imageName) {
            // Create and show image modal
            const modalHtml = `
                <div class="modal fade" id="imageModal" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${imageName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img src="${imageUrl}" alt="${imageName}" class="img-fluid">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
            
            // Remove modal from DOM when hidden
            document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        function logout() {
            AuthAPI.logout();
        }
    </script>
</body>
</html>